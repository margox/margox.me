/**
 * Lightbox
 * @author margox
 * @version 1.0.0
 * @license MIT
 */
(function ($) {

    "use strict";

    $.fn.Lightbox = function (options) {

        var defaults = {
                    obj: null,
                    btnPrevText: "PREV",
                    btnNextText: "NEXT",
            },
            options      = $.extend(defaults, options),
            lightboxObj  = options.obj != null ? $(options.obj) : $(this),
            DataUrl      = "",
            ImageWidth   = 0,
            ImageHeight  = 0,
            SartX        = 0,
            SartY        = 0,
            StartWidth   = 0,
            StartHeight  = 0,
            EndX         = 0,
            EndY         = 0,
            EndWidth     = 0,
            EndHeight    = 0,
            MaxWidth     = 0,
            MaxHeight    = 0,
            ScaleRate    = 1,
            currentIndex = 0,
            Enable       = 1,
            timmer,
            lightboxWindowWrapper,
            lightboxWindow,
            lightboxWindowImage,
            lightboxWindowImageNext,
            lightboxPrev,
            lightboxNext,
            lightboxClose,
            lightboxGroup,
            lightboxGroupName;

        if (lightboxObj.length == 0) {
            return false;
        }

        if ($("#lightbox-window-wrapper").length == 0) {
            $("body").append('<div id="lightbox-window-wrapper"><div id="lightbox-window"><img src="#" id="lightbox-window-image" alt="current image placeholder"><img src="#" id="lightbox-window-image-next" alt="next image placeholder"></div><div id="lightbox-window-close"></div><a id="lightbox-window-btn-next">' + options.btnNextText + '</a><a id="lightbox-window-btn-prev">' + options.btnPrevText + '</a></div>')
        }

        lightboxWindowWrapper   = $("#lightbox-window-wrapper");
        lightboxWindow          = $("#lightbox-window");
        lightboxWindowImage     = $("#lightbox-window-image");
        lightboxWindowImageNext = $("#lightbox-window-image-next");
        lightboxPrev            = $("#lightbox-window-btn-prev");
        lightboxNext            = $("#lightbox-window-btn-next");
        lightboxClose           = $("#lightbox-window-close");

        lightboxObj.on("click", function () {

            lightboxGroupName = $(this).data('lightbox-group');

            if (lightboxGroupName) {
                lightboxGroup = $("[data-lightbox-group='" + lightboxGroupName + "']");
            } else {
                lightboxGroup = lightboxObj;
            }

            currentIndex = lightboxGroup.index(this);
            DataUrl      = $(this).attr("href");
            SartX        = $(this).offset().left;
            SartY        = $(this).offset().top - $(document).scrollTop();
            StartWidth   = $(this).width();
            StartHeight  = $(this).height();

            if (DataUrl) {

                $('#lightbox-window-image').remove();
                lightboxWindowImage = $('<img src="" id="lightbox-window-image"/>');
                lightboxWindowImage.appendTo(lightboxWindow);
                lightboxWindowWrapper.fadeIn();

                lightboxWindow.css({
                    width      : StartWidth,
                    height     : StartHeight,
                    marginLeft : SartX,
                    marginTop  : SartY
                });

                lightboxWindow.animate({
                    width      : $(window).width() * 0.4,
                    height     : $(window).height() * 0.8,
                    marginTop  : $(window).height() * 0.1,
                    marginLeft : $(window).width() * 0.3,
                    opacity    : 1
                }, 400);

                lightboxWindowImage.load(function () {

                    ImageHeight = this.naturalHeight;//ImageCache.height;
                    ImageWidth  = this.naturalWidth;//ImageCache.width;
                    MaxWidth    = $(window).width() - 120;
                    MaxHeight   = $(window).height() - 100;

                    if (ImageHeight > MaxHeight) {

                        ScaleRate   = MaxHeight / ImageHeight;
                        ImageHeight = MaxHeight;
                        ImageWidth  = ImageWidth * ScaleRate;

                        if (ImageWidth > MaxWidth) {

                            ScaleRate   = MaxWidth / ImageWidth;
                            ImageWidth  = MaxWidth;
                            ImageHeight = ImageHeight * ScaleRate;

                        }

                    }

                    if (ImageWidth > MaxWidth) {

                        ScaleRate   = MaxWidth / ImageWidth;
                        ImageWidth  = MaxWidth;
                        ImageHeight = ImageHeight * ScaleRate;

                        if (ImageHeight > MaxHeight) {

                            ScaleRate   = MaxHeight / ImageHeight;
                            ImageHeight = MaxHeight;
                            ImageWidth  = ImageWidth * ScaleRate;

                        }

                    }

                    lightboxWindowImage.width(ImageWidth);
                    lightboxWindowImage.height(ImageHeight);

                    //lightboxWindow.css({width:StartWidth,height:StartHeight,marginLeft:SartX,marginTop:SartY});
                    lightboxWindow.animate({
                        width      : ImageWidth,
                        height     : ImageHeight,
                        marginTop  : ($(window).height() / 2) - (ImageHeight / 2) - 5,
                        marginLeft : ($(window).width() / 2) - (ImageWidth / 2) - 5,
                        opacity    : 1
                    }, function () {
                        lightboxWindowImage.animate({
                            opacity: 1
                        });
                    });

                });

                lightboxWindowImage.attr("src", DataUrl);

            }

            lightboxPrev.unbind('click');
            lightboxNext.unbind('click');
            lightboxClose.unbind('click');

            lightboxClose.on("click", function () {

                var currentItem;

                if (currentIndex >= 0) {

                    clearInterval(timmer);
                    currentItem = lightboxGroup.eq(currentIndex);
                    EndX        = currentItem.offset().left;
                    EndY        = currentItem.offset().top - $(document).scrollTop();
                    EndWidth    = currentItem.width();
                    EndHeight   = currentItem.height();

                    lightboxWindow.animate({
                        width      : EndWidth,
                        height     : EndHeight,
                        marginTop  : EndY,
                        marginLeft : EndX,
                        opacity    : 0
                    }, function () {
                        lightboxWindowWrapper.fadeOut();
                    });

                }

            });

            lightboxNext.on("click", function () {
                Dolightbox('next');
            });

            lightboxPrev.on("click", function () {
                Dolightbox('prev');
            });

            return false;

        });

        function Dolightbox(event) {

            var NextIndex,
                ImgSrc;

            if (!Enable) {
                return false
            }

            if (event == 'next') {
                NextIndex = currentIndex < lightboxGroup.length - 1 ? currentIndex + 1 : 0;
            } else {
                NextIndex = currentIndex > 0 ? currentIndex - 1 : lightboxGroup.length - 1;
            }

            ImgSrc = lightboxGroup.eq(NextIndex).attr("href");

            lightboxWindowImage.animate({
                opacity: 0
            }, 300, function () {

                $('#lightbox-window-image').remove();
                lightboxWindowImage = $('<img src="" id="lightbox-window-image"/>');
                lightboxWindowImage.appendTo(lightboxWindow);
                currentIndex = NextIndex;

                lightboxWindowImage.load(function () {

                    ImageHeight = lightboxWindowImage[0].height;
                    ImageWidth  = lightboxWindowImage[0].width;
                    MaxWidth    = $(window).width() - 120;
                    MaxHeight   = $(window).height() - 100;

                    if (ImageHeight > MaxHeight) {

                        ScaleRate   = MaxHeight / ImageHeight;
                        ImageHeight = MaxHeight;
                        ImageWidth  = ImageWidth * ScaleRate;

                        if (ImageWidth > MaxWidth) {

                            ScaleRate   = MaxWidth / ImageWidth;
                            ImageWidth  = MaxWidth;
                            ImageHeight = ImageHeight * ScaleRate;

                        }

                    }

                    if (ImageWidth > MaxWidth) {

                        ScaleRate   = MaxWidth / ImageWidth;
                        ImageWidth  = MaxWidth;
                        ImageHeight = ImageHeight * ScaleRate;

                        if (ImageHeight > MaxHeight) {

                            ScaleRate   = MaxHeight / ImageHeight;
                            ImageHeight = MaxHeight;
                            ImageWidth  = ImageWidth * ScaleRate;

                        }

                    }

                    lightboxWindowImage.width(ImageWidth);
                    lightboxWindowImage.height(ImageHeight);
                    //lightboxWindow.css({width:StartWidth,height:StartHeight,marginLeft:SartX,marginTop:SartY});
                    
                    lightboxWindow.animate({
                        width      : ImageWidth,
                        height     : ImageHeight,
                        marginTop  : ($(window).height() / 2) - (ImageHeight / 2) - 5,
                        marginLeft : ($(window).width() / 2) - (ImageWidth / 2) - 5,
                        opacity    : 1
                    }, 300, function () {
                        lightboxWindowImage.animate({
                            opacity: 1
                        });
                    });

                });

                lightboxWindowImage.attr("src", ImgSrc);

            });

        }

    }

}(jQuery));